---
title: Roteamento Direto do Sistema de Telefonia
author: CarolynRowe
ms.author: crowe
manager: serdars
ms.date: 01/28/2019
ms.topic: article
ms.service: msteams
audience: admin
ms.collection:
- Teams_ITAdmin_Help
- M365-voice
ms.reviewer: nmurav
search.appverid: MET150
f1.keywords:
- NOCSH
description: Protocolos de Roteamento Direto
appliesto:
- Microsoft Teams
ms.openlocfilehash: 04e9507595ef721ced5d47eb58646559601c5cab
ms.sourcegitcommit: 8750f98d59e74e3835d762d510fb0e038c8f17eb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/20/2021
ms.locfileid: "51899122"
---
# <a name="direct-routing---sip-protocol"></a><span data-ttu-id="e495d-103">Roteamento Direto - protocolo SIP</span><span class="sxs-lookup"><span data-stu-id="e495d-103">Direct Routing - SIP protocol</span></span>

<span data-ttu-id="e495d-104">Este artigo descreve como o Roteamento Direto implementa o Protocolo de Iniciação de Sessão (SIP).</span><span class="sxs-lookup"><span data-stu-id="e495d-104">This article describes how Direct Routing implements the Session Initiation Protocol (SIP).</span></span> <span data-ttu-id="e495d-105">Para rotear corretamente o tráfego entre um Controlador de Borda de Sessão (SBC) e o proxy SIP, alguns parâmetros SIP devem ter valores específicos.</span><span class="sxs-lookup"><span data-stu-id="e495d-105">To properly route traffic between a Session Border Controller (SBC) and the SIP proxy, some SIP parameters must have specific values.</span></span> <span data-ttu-id="e495d-106">Este artigo destina-se aos administradores de voz responsáveis por configurar a conexão entre o SBC local e o serviço proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="e495d-106">This article is intended for voice administrators who are responsible for configuring the connection between the on-premises SBC and the SIP proxy service.</span></span>

## <a name="processing-the-incoming-request-finding-the-tenant-and-user"></a><span data-ttu-id="e495d-107">Processamento da solicitação de entrada: localizar o locatário e o usuário</span><span class="sxs-lookup"><span data-stu-id="e495d-107">Processing the incoming request: finding the tenant and user</span></span>

<span data-ttu-id="e495d-108">Antes que uma chamada de entrada ou saída possa ser processada, as mensagens OPTIONS são trocadas entre o Proxy SIP e o SBC.</span><span class="sxs-lookup"><span data-stu-id="e495d-108">Before an incoming or outbound call can be processed, OPTIONS messages are exchanged between SIP Proxy and the SBC.</span></span> <span data-ttu-id="e495d-109">Essas mensagens OPTIONS permitem que o Proxy SIP forneça os recursos permitidos ao SBC.</span><span class="sxs-lookup"><span data-stu-id="e495d-109">These OPTIONS messages allow SIP Proxy to provide the allowed capabilities to SBC.</span></span> <span data-ttu-id="e495d-110">É importante que a negociação OPTIONS seja bem-sucedida (resposta 200OK), permitindo maior comunicação entre SBC e Proxy SIP para estabelecer chamadas.</span><span class="sxs-lookup"><span data-stu-id="e495d-110">It is important for OPTIONS negotiation to be successful (200OK response), allowing for further communication between SBC and SIP Proxy for establishing calls.</span></span> <span data-ttu-id="e495d-111">Os headers SIP em uma mensagem OPTIONS para Proxy SIP são fornecidos como um exemplo abaixo:</span><span class="sxs-lookup"><span data-stu-id="e495d-111">The SIP headers in an OPTIONS messages to SIP Proxy are provided as an example below:</span></span>

| <span data-ttu-id="e495d-112">Nome do parâmetro</span><span class="sxs-lookup"><span data-stu-id="e495d-112">Parameter name</span></span> | <span data-ttu-id="e495d-113">Exemplo do valor</span><span class="sxs-lookup"><span data-stu-id="e495d-113">Example of the value</span></span> | 
| :---------------------  |:---------------------- |
| <span data-ttu-id="e495d-114">Request-URI</span><span class="sxs-lookup"><span data-stu-id="e495d-114">Request-URI</span></span> | <span data-ttu-id="e495d-115">OPÇÕES sip:sip.pstnhub.microsoft.com:5061 SIP /2.0</span><span class="sxs-lookup"><span data-stu-id="e495d-115">OPTIONS sip:sip.pstnhub.microsoft.com:5061 SIP /2.0</span></span> |
| <span data-ttu-id="e495d-116">Via Header</span><span class="sxs-lookup"><span data-stu-id="e495d-116">Via Header</span></span> | <span data-ttu-id="e495d-117">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span><span class="sxs-lookup"><span data-stu-id="e495d-117">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span></span> | 
| <span data-ttu-id="e495d-118">Max-Forwards header</span><span class="sxs-lookup"><span data-stu-id="e495d-118">Max-Forwards header</span></span> | <span data-ttu-id="e495d-119">Max-Forwards:68</span><span class="sxs-lookup"><span data-stu-id="e495d-119">Max-Forwards:68</span></span> |
| <span data-ttu-id="e495d-120">De Header</span><span class="sxs-lookup"><span data-stu-id="e495d-120">From Header</span></span> | <span data-ttu-id="e495d-121">Do Header From: <sip:sbc1.adatum.biz:5058></span><span class="sxs-lookup"><span data-stu-id="e495d-121">From Header From: <sip:sbc1.adatum.biz:5058></span></span> |
| <span data-ttu-id="e495d-122">Para o Header</span><span class="sxs-lookup"><span data-stu-id="e495d-122">To Header</span></span> | <span data-ttu-id="e495d-123">Para: <sip:sip.pstnhub.microsoft.com:5061></span><span class="sxs-lookup"><span data-stu-id="e495d-123">To: <sip:sip.pstnhub.microsoft.com:5061></span></span> |
| <span data-ttu-id="e495d-124">Header CSeq</span><span class="sxs-lookup"><span data-stu-id="e495d-124">CSeq header</span></span> | <span data-ttu-id="e495d-125">CSeq: 1 INVITE</span><span class="sxs-lookup"><span data-stu-id="e495d-125">CSeq: 1 INVITE</span></span> | 
| <span data-ttu-id="e495d-126">Header de contato</span><span class="sxs-lookup"><span data-stu-id="e495d-126">Contact Header</span></span> | <span data-ttu-id="e495d-127">Contato: <sip:sbc1.adatum.biz:50588;transport=tls></span><span class="sxs-lookup"><span data-stu-id="e495d-127">Contact: <sip:sbc1.adatum.biz:50588;transport=tls></span></span> |

> [!NOTE]
> <span data-ttu-id="e495d-128">Os headers SIP não contêm userinfo no URI SIP em uso.</span><span class="sxs-lookup"><span data-stu-id="e495d-128">The SIP headers do not contain userinfo in the SIP URI in use.</span></span> <span data-ttu-id="e495d-129">De acordo com [a RFC 3261, seção 19.1.1](https://tools.ietf.org/html/rfc3261#section-19.1.1), a parte userinfo de um URI é opcional e PODE estar ausente quando o host de destino não tem uma noção de usuários ou quando o próprio hosst é o recurso que está sendo identificado.</span><span class="sxs-lookup"><span data-stu-id="e495d-129">As per [RFC 3261, section 19.1.1](https://tools.ietf.org/html/rfc3261#section-19.1.1), the userinfo part of a URI is optional and MAY be absent when the destination host does not have a notion of users or when the hosst itself is the resource being identified.</span></span> <span data-ttu-id="e495d-130">Se o sinal @ estiver presente em um URI SIP, o campo do usuário NÃO DEVE estar vazio.</span><span class="sxs-lookup"><span data-stu-id="e495d-130">If the @ sign is present in a SIP URI, the user field MUST NOT be empty.</span></span>

<span data-ttu-id="e495d-131">Em uma chamada de entrada, o proxy SIP precisa encontrar o locatário ao qual a chamada está destinada e encontrar o usuário específico dentro desse locatário.</span><span class="sxs-lookup"><span data-stu-id="e495d-131">On an incoming call, the SIP proxy needs to find the tenant to which the call is destined and find the specific user within this tenant.</span></span> <span data-ttu-id="e495d-132">O administrador de locatários pode configurar números não DID, por exemplo +1001, em vários locatários.</span><span class="sxs-lookup"><span data-stu-id="e495d-132">The tenant administrator might configure non-DID numbers, for example +1001, in multiple tenants.</span></span> <span data-ttu-id="e495d-133">Portanto, é importante encontrar o locatário específico no qual realizar a análise de números, pois os números não DID podem ser os mesmos em várias organizações do Microsoft 365 ou Office 365.</span><span class="sxs-lookup"><span data-stu-id="e495d-133">Therefore, it is important to find the specific tenant on which to perform the number lookup because the non-DID numbers might be the same in multiple Microsoft 365 or Office 365 organizations.</span></span>  

<span data-ttu-id="e495d-134">Esta seção descreve como o proxy SIP localiza o locatário e o usuário e executa a autenticação do SBC na conexão de entrada.</span><span class="sxs-lookup"><span data-stu-id="e495d-134">This section describes how the SIP proxy finds the tenant and the user, and performs authentication of the SBC on the incoming connection.</span></span>

<span data-ttu-id="e495d-135">Veja a seguir um exemplo da mensagem Convite SIP em uma chamada de entrada:</span><span class="sxs-lookup"><span data-stu-id="e495d-135">The following is an example of the SIP Invite message on an incoming call:</span></span>

| <span data-ttu-id="e495d-136">Nome do parâmetro</span><span class="sxs-lookup"><span data-stu-id="e495d-136">Parameter name</span></span> | <span data-ttu-id="e495d-137">Exemplo do valor</span><span class="sxs-lookup"><span data-stu-id="e495d-137">Example of the value</span></span> | 
| :---------------------  |:---------------------- |
| <span data-ttu-id="e495d-138">Request-URI</span><span class="sxs-lookup"><span data-stu-id="e495d-138">Request-URI</span></span> | <span data-ttu-id="e495d-139">CONVIDAR SIP:+18338006777@SIP.PSTNHUB.MICROSOFT.COM SIP /2.0</span><span class="sxs-lookup"><span data-stu-id="e495d-139">INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0</span></span> |
| <span data-ttu-id="e495d-140">Via Header</span><span class="sxs-lookup"><span data-stu-id="e495d-140">Via Header</span></span> | <span data-ttu-id="e495d-141">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span><span class="sxs-lookup"><span data-stu-id="e495d-141">Via: SIP/2.0/TLS sbc1.adatum.biz:5058;alias;branch=z9hG4bKac2121518978</span></span> | 
| <span data-ttu-id="e495d-142">Max-Forwards header</span><span class="sxs-lookup"><span data-stu-id="e495d-142">Max-Forwards header</span></span> | <span data-ttu-id="e495d-143">Max-Forwards:68</span><span class="sxs-lookup"><span data-stu-id="e495d-143">Max-Forwards:68</span></span> |
| <span data-ttu-id="e495d-144">De Header</span><span class="sxs-lookup"><span data-stu-id="e495d-144">From Header</span></span> | <span data-ttu-id="e495d-145">From Header From: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679</span><span class="sxs-lookup"><span data-stu-id="e495d-145">From Header From: <sip:7168712781@sbc1.adatum.biz;transport=udp;tag=1c747237679</span></span> |
| <span data-ttu-id="e495d-146">Para o Header</span><span class="sxs-lookup"><span data-stu-id="e495d-146">To Header</span></span> | <span data-ttu-id="e495d-147">Para: sip:+183338006777@sbc1.adatum.biz</span><span class="sxs-lookup"><span data-stu-id="e495d-147">To: sip:+183338006777@sbc1.adatum.biz</span></span> | 
| <span data-ttu-id="e495d-148">Header CSeq</span><span class="sxs-lookup"><span data-stu-id="e495d-148">CSeq header</span></span> | <span data-ttu-id="e495d-149">CSeq: 1 INVITE</span><span class="sxs-lookup"><span data-stu-id="e495d-149">CSeq: 1 INVITE</span></span> | 
| <span data-ttu-id="e495d-150">Header de contato</span><span class="sxs-lookup"><span data-stu-id="e495d-150">Contact Header</span></span> | <span data-ttu-id="e495d-151">Contato: <sip: 68712781@sbc1.adatum.biz:5058;transport=tls></span><span class="sxs-lookup"><span data-stu-id="e495d-151">Contact: <sip: 68712781@sbc1.adatum.biz:5058;transport=tls></span></span> | 

<span data-ttu-id="e495d-152">Ao receber o convite, o proxy SIP executa as seguintes etapas:</span><span class="sxs-lookup"><span data-stu-id="e495d-152">On receiving the invite, the SIP proxy performs the following steps:</span></span>

1. <span data-ttu-id="e495d-153">Verifique o certificado.</span><span class="sxs-lookup"><span data-stu-id="e495d-153">Check the certificate.</span></span> <span data-ttu-id="e495d-154">Na conexão inicial, o serviço de Roteamento Direto pega o nome FQDN apresentado no header Contato e o corresponde ao Nome Comum ou Nome Alternativo de Assunto do certificado apresentado.</span><span class="sxs-lookup"><span data-stu-id="e495d-154">On the initial connection, the Direct Routing service takes the FQDN name presented in the Contact header and matches it to the Common Name or Subject Alternative name of the presented certificate.</span></span> <span data-ttu-id="e495d-155">O nome SBC deve corresponder a uma das seguintes opções:</span><span class="sxs-lookup"><span data-stu-id="e495d-155">The SBC name must match one of the following options:</span></span>

   - <span data-ttu-id="e495d-156">Opção 1.</span><span class="sxs-lookup"><span data-stu-id="e495d-156">Option 1.</span></span> <span data-ttu-id="e495d-157">O nome FQDN completo apresentado no header Contato deve corresponder ao nome comum/nome alternativo do certificado apresentado.</span><span class="sxs-lookup"><span data-stu-id="e495d-157">The full FQDN name presented in the Contact header must match the Common Name/Subject Alternative name of the presented certificate.</span></span>  

   - <span data-ttu-id="e495d-158">Opção 2. </span><span class="sxs-lookup"><span data-stu-id="e495d-158">Option 2.</span></span> <span data-ttu-id="e495d-159">A parte de domínio do nome FQDN apresentada no header contact (por exemplo, adatum.biz do nome FQDN sbc1.adatum.biz) deve corresponder ao valor curinga em Nome Comum/Nome Alternativo do Assunto (por exemplo \*.adatum.biz).</span><span class="sxs-lookup"><span data-stu-id="e495d-159">The domain portion of the FQDN name presented in the Contact header (for example adatum.biz of the FQDN name sbc1.adatum.biz) must match the wildcard value in Common Name/Subject Alternative Name (for example \*.adatum.biz).</span></span>

2. <span data-ttu-id="e495d-160">Tente encontrar um locatário usando o nome FQDN completo apresentado no header Contato.</span><span class="sxs-lookup"><span data-stu-id="e495d-160">Try to find a tenant using the full FQDN name presented in the Contact header.</span></span>  

   <span data-ttu-id="e495d-161">Verifique se o nome FQDN do header de contato (sbc1.adatum.biz) está registrado como um nome DNS em qualquer organização do Microsoft 365 ou Office 365.</span><span class="sxs-lookup"><span data-stu-id="e495d-161">Check if the FQDN name from the Contact header (sbc1.adatum.biz) is registered as a DNS name in any Microsoft 365 or Office 365 organization.</span></span> <span data-ttu-id="e495d-162">Se for encontrada, a procurar o usuário será realizada no locatário que tem o FQDN SBC registrado como um nome de domínio.</span><span class="sxs-lookup"><span data-stu-id="e495d-162">If found, the lookup of the user is performed in the tenant that has the SBC FQDN registered as a Domain name.</span></span> <span data-ttu-id="e495d-163">Se não for encontrada, a Etapa 3 será aplicada.</span><span class="sxs-lookup"><span data-stu-id="e495d-163">If not found, Step 3 applies.</span></span>   

3. <span data-ttu-id="e495d-164">A etapa 3 só se aplica se a Etapa 2 falhar.</span><span class="sxs-lookup"><span data-stu-id="e495d-164">Step 3 only applies if Step 2 failed.</span></span> 

   <span data-ttu-id="e495d-165">Remova a parte do host do FQDN, apresentada no header de contato (FQDN: sbc12.adatum.biz, após remover a parte do host: adatum.biz) e verifique se esse nome está registrado como um nome DNS em qualquer organização do Microsoft 365 ou Office 365.</span><span class="sxs-lookup"><span data-stu-id="e495d-165">Remove the host portion from the FQDN, presented in the Contact header (FQDN: sbc12.adatum.biz, after removing the host portion: adatum.biz), and check if this name is registered as a DNS name in any Microsoft 365 or Office 365 organization.</span></span> <span data-ttu-id="e495d-166">Se for encontrada, a procurar usuário será realizada neste locatário.</span><span class="sxs-lookup"><span data-stu-id="e495d-166">If found, the user lookup is performed in this tenant.</span></span> <span data-ttu-id="e495d-167">Se não for encontrada, a chamada falhará.</span><span class="sxs-lookup"><span data-stu-id="e495d-167">If not found, the call fails.</span></span>

4. <span data-ttu-id="e495d-168">Usando o número de telefone apresentado no Request-URI, execute a consulta de número reverso no locatário encontrado na Etapa 2 ou 3.</span><span class="sxs-lookup"><span data-stu-id="e495d-168">Using the phone number presented in the Request-URI, perform the reverse number lookup within the tenant found in Step 2 or 3.</span></span> <span data-ttu-id="e495d-169">Corresponder o número de telefone apresentado a um URI SIP do usuário no locatário encontrado na etapa anterior.</span><span class="sxs-lookup"><span data-stu-id="e495d-169">Match the presented phone number to a user SIP URI within the tenant found on the previous step.</span></span>

5. <span data-ttu-id="e495d-170">Aplicar configurações de tronco.</span><span class="sxs-lookup"><span data-stu-id="e495d-170">Apply trunk settings.</span></span> <span data-ttu-id="e495d-171">Encontre os parâmetros definidos pelo administrador do locatário para este SBC.</span><span class="sxs-lookup"><span data-stu-id="e495d-171">Find the parameters set by the tenant admin for this SBC.</span></span>

   <span data-ttu-id="e495d-172">A Microsoft não dá suporte a ter um proxy SIP de terceiros ou Servidor de Agente de Usuário entre o proxy SIP da Microsoft e o SBC emparelhado, que pode modificar o URI de solicitação criado pelo SBC emparelhado.</span><span class="sxs-lookup"><span data-stu-id="e495d-172">Microsoft does not support having a third-party SIP proxy or User Agent Server between the Microsoft SIP proxy and the paired SBC, which might modify the Request URI created by the paired SBC.</span></span>

   <span data-ttu-id="e495d-173">Os requisitos para as duas buscas (etapas 2 e 3) necessárias para o cenário em que um SBC está interconectado a muitos locatários (cenário de operadora) são abordados posteriormente neste artigo.</span><span class="sxs-lookup"><span data-stu-id="e495d-173">The requirements for the two lookups (steps 2 and 3) needed for the scenario where one SBC is interconnected to many tenants (carrier scenario) are covered later in this article.</span></span>

### <a name="detailed-requirements-for-contact-header-and-request-uri"></a><span data-ttu-id="e495d-174">Requisitos detalhados para o header de contato e o Request-URI</span><span class="sxs-lookup"><span data-stu-id="e495d-174">Detailed requirements for Contact header and Request-URI</span></span>

#### <a name="contact-header"></a><span data-ttu-id="e495d-175">Header de contato</span><span class="sxs-lookup"><span data-stu-id="e495d-175">Contact header</span></span>

<span data-ttu-id="e495d-176">Para todas as mensagens SIP de entrada (OPÇÕES, CONVIDAR) para o proxy SIP da Microsoft, o header de contato deve ter o FQDN SBC emparelhado no nome do host URI da seguinte forma:</span><span class="sxs-lookup"><span data-stu-id="e495d-176">For all incoming SIP messages (OPTIONS, INVITE) to the Microsoft SIP proxy, the Contact header must have the paired SBC FQDN in the URI hostname as follows:</span></span>

<span data-ttu-id="e495d-177">Sintaxe: Contato: <sip:phone ou sip address@FQDN do SBC;transport=tls></span><span class="sxs-lookup"><span data-stu-id="e495d-177">Syntax: Contact:  <sip:phone or sip address@FQDN of the SBC;transport=tls></span></span> 

<span data-ttu-id="e495d-178">De acordo [com a RFC 3261, seção 11.1](https://tools.ietf.org/html/rfc3261#section-11.1), um campo de header de contato pode estar presente em uma mensagem OPTIONS.</span><span class="sxs-lookup"><span data-stu-id="e495d-178">As per [RFC 3261, section 11.1](https://tools.ietf.org/html/rfc3261#section-11.1), a Contact header field MAY be present in an OPTIONS message.</span></span> <span data-ttu-id="e495d-179">No Roteamento Direto, o header de contato é necessário.</span><span class="sxs-lookup"><span data-stu-id="e495d-179">In Direct Routing the contact header is required.</span></span> <span data-ttu-id="e495d-180">Para mensagens INVITE no formato acima, para mensagens OPTIONS, o userinfo pode ser removido do URI SIP e somente FQDN enviado no formato da seguinte maneira:</span><span class="sxs-lookup"><span data-stu-id="e495d-180">For INVITE messages in format above, for OPTIONS messages the userinfo can be removed from SIP URI and only FQDN sent in format as follows:</span></span>

<span data-ttu-id="e495d-181">Sintaxe: Contato: <sip:FQDN do SBC;transport=tls></span><span class="sxs-lookup"><span data-stu-id="e495d-181">Syntax: Contact:  <sip:FQDN of the SBC;transport=tls></span></span>

<span data-ttu-id="e495d-182">Esse nome (FQDN) também deve estar nos campos Nome Comum ou Nome alternativo do certificado apresentado.</span><span class="sxs-lookup"><span data-stu-id="e495d-182">This name (FQDN) must also be in the Common Name or Subject Alternative name field(s) of the presented certificate.</span></span> <span data-ttu-id="e495d-183">A Microsoft dá suporte ao uso de valores curinga dos nomes(s) nos campos Nome Comum ou Nome Alternativo de Assunto do certificado.</span><span class="sxs-lookup"><span data-stu-id="e495d-183">Microsoft supports using wildcard values of the name(s) in the Common Name or Subject Alternative Name fields of the certificate.</span></span>   

<span data-ttu-id="e495d-184">O suporte para curingas está descrito na [RFC 2818, seção 3.1](https://tools.ietf.org/html/rfc2818#section-3.1).</span><span class="sxs-lookup"><span data-stu-id="e495d-184">The support for wildcards is described in [RFC 2818, section 3.1](https://tools.ietf.org/html/rfc2818#section-3.1).</span></span> <span data-ttu-id="e495d-185">Especificamente:</span><span class="sxs-lookup"><span data-stu-id="e495d-185">Specifically:</span></span>

<span data-ttu-id="e495d-186">*"Os nomes podem conter o caractere curinga que é considerado para corresponder a qualquer componente de nome de domínio único \* ou fragmento de componente. Por exemplo, .a.com corresponde foo.a.com mas não bar.foo.a.com. f .com corresponde foo.com, mas não \* \* bar.com."*</span><span class="sxs-lookup"><span data-stu-id="e495d-186">*"Names may contain the wildcard character \* which is considered to match any single domain name component or component fragment. E.g., \*.a.com matches foo.a.com but not bar.foo.a.com. f\*.com matches foo.com but not bar.com."*</span></span>

<span data-ttu-id="e495d-187">Se mais de um valor no header contato apresentado em uma mensagem SIP for enviado pelo SBC, somente a parte FQDN do primeiro valor do header contato será usada.</span><span class="sxs-lookup"><span data-stu-id="e495d-187">If more than one value in the Contact header presented in a SIP message is sent by the SBC, only the FQDN portion of the first value of the Contact header is used.</span></span>

<span data-ttu-id="e495d-188">Como regra geral para Roteamento Direto, é importante que o FQDN seja usado para preencher URI SIP em vez de IP.</span><span class="sxs-lookup"><span data-stu-id="e495d-188">As rule of thumb for Direct Routing, it is important that FQDN is used to populate SIP URI instead of IP.</span></span> <span data-ttu-id="e495d-189">Uma mensagem INVITE ou OPTIONS de entrada para o Proxy SIP com o header de Contato onde hostname é representado por IP e não FQDN, a conexão será recusada com o 403 Forbidden.</span><span class="sxs-lookup"><span data-stu-id="e495d-189">An incoming INVITE or OPTIONS message to SIP Proxy with Contact header where hostname is represented by IP and not FQDN, the connection will be refused with 403 Forbidden.</span></span>

#### <a name="request-uri"></a><span data-ttu-id="e495d-190">Request-URI</span><span class="sxs-lookup"><span data-stu-id="e495d-190">Request-URI</span></span> 

<span data-ttu-id="e495d-191">Para todas as chamadas de entrada, o Request-URI é usado para corresponder o número de telefone a um usuário.</span><span class="sxs-lookup"><span data-stu-id="e495d-191">For all incoming calls, the Request-URI is used to match the phone number to a user.</span></span>   

<span data-ttu-id="e495d-192">Atualmente, o número de telefone deve conter um sinal de a mais (+), conforme mostrado no exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="e495d-192">Currently The phone number must contain a plus sign (+) as shown in the following example.</span></span> 

```console
INVITE sip:+18338006777@sip.pstnhub.microsoft.com SIP /2.0
```

## <a name="contact-and-record-route-headers-considerations"></a><span data-ttu-id="e495d-193">Considerações sobre Record-Route de contatos e Record-Route de headers</span><span class="sxs-lookup"><span data-stu-id="e495d-193">Contact and Record-Route headers considerations</span></span>

<span data-ttu-id="e495d-194">O proxy SIP precisa calcular o FQDN do próximo salto para novas transações de cliente na caixa de diálogo (por exemplo, Bye ou Re-Invite) e ao responder a Opções SIP.</span><span class="sxs-lookup"><span data-stu-id="e495d-194">The SIP proxy needs to calculate the next hop FQDN for new in-dialog client transactions (for example Bye or Re-Invite), and when replying to SIP Options.</span></span> <span data-ttu-id="e495d-195">Os contatos ou Record-Route são usados.</span><span class="sxs-lookup"><span data-stu-id="e495d-195">Either Contact or Record-Route are used.</span></span> 

<span data-ttu-id="e495d-196">De acordo com [o RFC 3261, seção 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8), o header de contato é necessário em qualquer solicitação que possa resultar em uma nova caixa de diálogo.</span><span class="sxs-lookup"><span data-stu-id="e495d-196">According to [RFC 3261, section 8.1.1.8](https://tools.ietf.org/html/rfc3261#section-8.1.1.8), Contact header is required in any request that can result in a new dialog.</span></span> <span data-ttu-id="e495d-197">A Record-Route só será necessária se um proxy quiser permanecer no caminho das solicitações futuras em uma caixa de diálogo.</span><span class="sxs-lookup"><span data-stu-id="e495d-197">The Record-Route is only required if a proxy wants to stay on the path of future requests in a dialog.</span></span> <span data-ttu-id="e495d-198">Se um SBC de proxy estiver em uso com a Otimização de Mídia [Local](./direct-routing-media-optimization.md)para Roteamento Direto, uma rota de registro precisará ser configurada conforme o SBC do proxy precisa permanecer na rota.</span><span class="sxs-lookup"><span data-stu-id="e495d-198">If a proxy SBC is in use with [Local Media Optimization for Direct Routing](./direct-routing-media-optimization.md), a record route will need to be configured as the proxy SBC needs to stay in the route.</span></span> 

<span data-ttu-id="e495d-199">A Microsoft recomenda usar somente o header contato se um SBC proxy não for usado:</span><span class="sxs-lookup"><span data-stu-id="e495d-199">Microsoft recommends using only Contact header if a proxy SBC is not used:</span></span>

- <span data-ttu-id="e495d-200">Por [RFC 3261, seção 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route é usado se um proxy quiser permanecer no caminho de solicitações futuras em uma caixa de diálogo, o que não é essencial se nenhum SBC proxy estiver configurado à medida que todo o tráfego fica entre o proxy SIP da Microsoft e o SBC emparelhado.</span><span class="sxs-lookup"><span data-stu-id="e495d-200">Per [RFC 3261, section 20.30](https://tools.ietf.org/html/rfc3261#section-20.30), Record-Route is used if a proxy wants to stay on the path of future requests in a dialog, which is not essential if no proxy SBC is configured as all traffic goes between the Microsoft SIP proxy and the paired SBC.</span></span> 

- <span data-ttu-id="e495d-201">O proxy SIP da Microsoft usa apenas o header contact (não Record-Route) para determinar o próximo salto ao enviar opções de ping de saída.</span><span class="sxs-lookup"><span data-stu-id="e495d-201">The Microsoft SIP proxy uses only Contact header (not Record-Route) to determine the next hop when sending outbound ping Options.</span></span> <span data-ttu-id="e495d-202">Configurar apenas um parâmetro (Contato) em vez de dois (Contato e Rota de Registro) simplifica a administração se um SBC proxy não estiver em uso.</span><span class="sxs-lookup"><span data-stu-id="e495d-202">Configuring only one parameter (Contact) instead of two (Contact and Record-Route) simplifies the administration if a proxy SBC is not in use.</span></span> 

<span data-ttu-id="e495d-203">Para calcular o próximo salto, o proxy SIP usa:</span><span class="sxs-lookup"><span data-stu-id="e495d-203">To calculate the next hop, the SIP proxy uses:</span></span>

- <span data-ttu-id="e495d-204">Prioridade 1.</span><span class="sxs-lookup"><span data-stu-id="e495d-204">Priority 1.</span></span> <span data-ttu-id="e495d-205">Rota de registro de nível superior.</span><span class="sxs-lookup"><span data-stu-id="e495d-205">Top-level Record-Route.</span></span> <span data-ttu-id="e495d-206">Se o Record-Route de nível superior contiver o nome FQDN, o nome FQDN será usado para fazer a conexão de saída na caixa de diálogo.</span><span class="sxs-lookup"><span data-stu-id="e495d-206">If the top-level Record-Route contains the FQDN name, the FQDN name is used to make the outbound in-dialog connection.</span></span>

- <span data-ttu-id="e495d-207">Prioridade 2.</span><span class="sxs-lookup"><span data-stu-id="e495d-207">Priority 2.</span></span> <span data-ttu-id="e495d-208">Header de contato.</span><span class="sxs-lookup"><span data-stu-id="e495d-208">Contact header.</span></span> <span data-ttu-id="e495d-209">Se Record-Route não existir, o proxy SIP procurará o valor do header contact para fazer a conexão de saída.</span><span class="sxs-lookup"><span data-stu-id="e495d-209">If Record-Route does not exist, the SIP proxy will look up the value of the Contact header to make the outbound connection.</span></span> <span data-ttu-id="e495d-210">(Esta é a configuração recomendada.)</span><span class="sxs-lookup"><span data-stu-id="e495d-210">(This is the recommended configuration.)</span></span>

<span data-ttu-id="e495d-211">Se Contact e Record-Route for usado, o administrador do SBC deverá manter seus valores idênticos, o que causa sobrecarga administrativa.</span><span class="sxs-lookup"><span data-stu-id="e495d-211">If both Contact and Record-Route are used, the SBC administrator must keep their values identical, which causes administrative overhead.</span></span> 

### <a name="use-of-fqdn-name-in-contact-or-record-route"></a><span data-ttu-id="e495d-212">Uso do nome FQDN em Contato ou Record-Route</span><span class="sxs-lookup"><span data-stu-id="e495d-212">Use of FQDN name in Contact or Record-Route</span></span>

<span data-ttu-id="e495d-213">Não há suporte para o uso de um endereço IP no Record-Route ou contato.</span><span class="sxs-lookup"><span data-stu-id="e495d-213">Use of an IP address is not supported in either Record-Route or Contact.</span></span> <span data-ttu-id="e495d-214">A única opção suportada é um FQDN, que deve corresponder ao Nome Comum ou Nome Alternativo de Assunto do certificado SBC (há suporte para valores curinga no certificado).</span><span class="sxs-lookup"><span data-stu-id="e495d-214">The only supported option is an FQDN, which must match either the Common Name or Subject Alternative Name of the SBC certificate (wildcard values in the certificate are supported).</span></span>

- <span data-ttu-id="e495d-215">Se um endereço IP for apresentado em Rota de Registro ou Contato, a verificação de certificado falhará e a chamada falhará.</span><span class="sxs-lookup"><span data-stu-id="e495d-215">If an IP address is presented in Record-route or Contact, the certificate check fails and the call fails.</span></span>

- <span data-ttu-id="e495d-216">Se o FQDN não corresponder ao valor do Nome Alternativo Comum ou Assunto no certificado apresentado, a chamada falhará.</span><span class="sxs-lookup"><span data-stu-id="e495d-216">If the FQDN does not match the value of the Common or Subject Alternative Name in the presented certificate, the call fails.</span></span> 

## <a name="inbound-call-sip-dialog-description"></a><span data-ttu-id="e495d-217">Chamada de entrada: descrição da caixa de diálogo SIP</span><span class="sxs-lookup"><span data-stu-id="e495d-217">Inbound call: SIP dialog description</span></span>

<span data-ttu-id="e495d-218">A tabela a seguir resume as diferenças de fluxo de chamada e semelhanças entre os modos de bypass e bypass:</span><span class="sxs-lookup"><span data-stu-id="e495d-218">The following table below summarizes the call flow differences and similarities between non-bypass and bypass modes:</span></span>

| <span data-ttu-id="e495d-219">Nome do parâmetro</span><span class="sxs-lookup"><span data-stu-id="e495d-219">Parameter name</span></span> | <span data-ttu-id="e495d-220">Modo não bypass</span><span class="sxs-lookup"><span data-stu-id="e495d-220">Non-bypass mode</span></span> | <span data-ttu-id="e495d-221">Modo bypass</span><span class="sxs-lookup"><span data-stu-id="e495d-221">Bypass mode</span></span>
| :---------------------  |:---------------------- |:----------------|
| <span data-ttu-id="e495d-222">Candidatos de mídia em 183 e 200 mensagens provenientes</span><span class="sxs-lookup"><span data-stu-id="e495d-222">Media candidates in 183 and 200 messages coming from</span></span> | <span data-ttu-id="e495d-223">Processadores de mídia</span><span class="sxs-lookup"><span data-stu-id="e495d-223">Media processors</span></span> | <span data-ttu-id="e495d-224">Clientes</span><span class="sxs-lookup"><span data-stu-id="e495d-224">Clients</span></span> | 
| <span data-ttu-id="e495d-225">Número de 183 mensagens que o SBC pode receber</span><span class="sxs-lookup"><span data-stu-id="e495d-225">Number of 183 messages SBC can receive</span></span> | <span data-ttu-id="e495d-226">Um por sessão</span><span class="sxs-lookup"><span data-stu-id="e495d-226">One per session</span></span> | <span data-ttu-id="e495d-227">Vários</span><span class="sxs-lookup"><span data-stu-id="e495d-227">Multiple</span></span> | 
| <span data-ttu-id="e495d-228">A chamada pode ser com resposta provisória (183)</span><span class="sxs-lookup"><span data-stu-id="e495d-228">Call can be with provisional answer (183)</span></span> | <span data-ttu-id="e495d-229">Sim</span><span class="sxs-lookup"><span data-stu-id="e495d-229">Yes</span></span> | <span data-ttu-id="e495d-230">Sim</span><span class="sxs-lookup"><span data-stu-id="e495d-230">Yes</span></span> |
| <span data-ttu-id="e495d-231">A chamada pode estar sem resposta provisória (183)</span><span class="sxs-lookup"><span data-stu-id="e495d-231">Call can be without provisional answer (183)</span></span> | <span data-ttu-id="e495d-232">Sim</span><span class="sxs-lookup"><span data-stu-id="e495d-232">Yes</span></span> | <span data-ttu-id="e495d-233">Sim</span><span class="sxs-lookup"><span data-stu-id="e495d-233">Yes</span></span> |

###  <a name="non-media-bypass-flow"></a><span data-ttu-id="e495d-234">Fluxo de bypass que não seja de mídia</span><span class="sxs-lookup"><span data-stu-id="e495d-234">Non-media bypass flow</span></span>

<span data-ttu-id="e495d-235">Um usuário do Teams pode ter vários pontos de extremidade ao mesmo tempo.</span><span class="sxs-lookup"><span data-stu-id="e495d-235">A Teams user might have multiple endpoints at the same time.</span></span> <span data-ttu-id="e495d-236">Por exemplo, cliente do Teams para Windows, cliente do Teams para iPhone e Teams Phone (cliente Do Teams Android).</span><span class="sxs-lookup"><span data-stu-id="e495d-236">For example, Teams for Windows client, Teams for iPhone client, and Teams Phone (Teams Android client).</span></span> <span data-ttu-id="e495d-237">Cada ponto de extremidade pode sinalizar um rest HTTP da seguinte forma:</span><span class="sxs-lookup"><span data-stu-id="e495d-237">Each endpoint might signal an HTTP rest as follows:</span></span>

-   <span data-ttu-id="e495d-238">Progresso da chamada – convertido pelo proxy SIP para a mensagem SIP 180.</span><span class="sxs-lookup"><span data-stu-id="e495d-238">Call progress – converted by the SIP proxy to the SIP message 180.</span></span> <span data-ttu-id="e495d-239">Ao receber a mensagem 180, o SBC deve gerar toque local.</span><span class="sxs-lookup"><span data-stu-id="e495d-239">On receiving message 180, the SBC must generate local ringing.</span></span>

-   <span data-ttu-id="e495d-240">Resposta de mídia – convertida pelo proxy SIP para a mensagem 183 com candidatos à mídia no Protocolo de Descrição da Sessão (SDP).</span><span class="sxs-lookup"><span data-stu-id="e495d-240">Media answer – converted by the SIP proxy to message 183 with media candidates in Session Description Protocol (SDP).</span></span> <span data-ttu-id="e495d-241">Ao receber a mensagem 183, o SBC espera se conectar aos candidatos de mídia recebidos na mensagem SDP.</span><span class="sxs-lookup"><span data-stu-id="e495d-241">On receiving message 183, the SBC expects to connect to the media candidates received in the SDP message.</span></span> 

    > [!NOTE]
    > <span data-ttu-id="e495d-242">Em alguns casos, a resposta de mídia pode não ser gerada e o ponto final pode responder com a mensagem "Chamada Aceita".</span><span class="sxs-lookup"><span data-stu-id="e495d-242">In some cases the Media answer might not be generated, and the end point might answer with “Call Accepted” message.</span></span>

-   <span data-ttu-id="e495d-243">Chamada aceita – convertida pelo proxy SIP para a mensagem SIP 200 com SDP.</span><span class="sxs-lookup"><span data-stu-id="e495d-243">Call accepted – converted by the SIP proxy to SIP message 200 with SDP.</span></span> <span data-ttu-id="e495d-244">Ao receber a mensagem 200, espera-se que o SBC envie e receba mídia de e para os candidatos SDP fornecidos.</span><span class="sxs-lookup"><span data-stu-id="e495d-244">On receiving message 200, the SBC is expected to send and receive media to and from the provided SDP candidates.</span></span>

    > [!NOTE]
    > <span data-ttu-id="e495d-245">O Roteamento Direto não dá suporte a Convite de Oferta Atrasada (Convidar sem SDP).</span><span class="sxs-lookup"><span data-stu-id="e495d-245">Direct Routing does not support Delayed Offer Invite (Invite without SDP).</span></span>

#### <a name="multiple-endpoints-ringing-with-provisional-answer"></a><span data-ttu-id="e495d-246">Vários pontos de extremidade tocando com resposta provisória</span><span class="sxs-lookup"><span data-stu-id="e495d-246">Multiple endpoints ringing with provisional answer</span></span>

1.  <span data-ttu-id="e495d-247">Ao receber o primeiro Convite do SBC, o proxy SIP envia a mensagem "SIP SIP/2.0 100 Tentando" e notifica todos os pontos de extremidade do usuário final sobre a chamada de entrada.</span><span class="sxs-lookup"><span data-stu-id="e495d-247">On receiving the first Invite from the SBC, the SIP proxy sends the message "SIP SIP/2.0 100 Trying" and notifies all end user endpoints about the incoming call.</span></span> 

2.  <span data-ttu-id="e495d-248">Após a notificação, cada ponto de extremidade começará a tocar e enviar mensagens "Andamento da chamada" para o proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="e495d-248">Upon notification, each endpoint will start ringing and sending "Call progress” messages to the SIP proxy.</span></span> <span data-ttu-id="e495d-249">Como um usuário do Teams pode ter vários pontos de extremidade, o proxy SIP pode receber várias mensagens de Progresso de Chamada.</span><span class="sxs-lookup"><span data-stu-id="e495d-249">Because a Teams user can have multiple end points, the SIP proxy might receive multiple Call Progress messages.</span></span>

3.  <span data-ttu-id="e495d-250">Para cada mensagem de Progresso de Chamada recebida dos clientes, o proxy SIP converte a mensagem Progresso da Chamada para a mensagem SIP "SIP SIP/2.0 180 Trying".</span><span class="sxs-lookup"><span data-stu-id="e495d-250">For every Call Progress message received from the clients, the SIP proxy converts the Call Progress message to the SIP message "SIP SIP/2.0 180 Trying".</span></span> <span data-ttu-id="e495d-251">O intervalo para o envio dessas mensagens é definido pelo intervalo de mensagens de recebimento do Controlador de Chamada.</span><span class="sxs-lookup"><span data-stu-id="e495d-251">The interval for sending such messages is defined by the interval of the receiving messages from the Call Controller.</span></span> <span data-ttu-id="e495d-252">No diagrama a seguir, há duas 180 mensagens geradas pelo proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="e495d-252">In the following diagram, there are two 180 messages generated by the SIP proxy.</span></span> <span data-ttu-id="e495d-253">Essas mensagens vêm dos dois pontos de extremidade do Teams do usuário.</span><span class="sxs-lookup"><span data-stu-id="e495d-253">These messages come from the two Teams endpoints of the user.</span></span> <span data-ttu-id="e495d-254">Cada cliente tem uma ID de Marca exclusiva.</span><span class="sxs-lookup"><span data-stu-id="e495d-254">The clients each have a unique Tag ID.</span></span>  <span data-ttu-id="e495d-255">Cada mensagem proveniente de um ponto de extremidade diferente será uma sessão separada (o parâmetro "tag" no campo "Para" será diferente).</span><span class="sxs-lookup"><span data-stu-id="e495d-255">Every message coming from a different endpoint will be a separate session (the parameter “tag” in the “To” field will be different).</span></span> <span data-ttu-id="e495d-256">Mas um ponto de extremidade pode não gerar a mensagem 180 e enviar a mensagem 183 imediatamente, conforme mostrado no diagrama a seguir.</span><span class="sxs-lookup"><span data-stu-id="e495d-256">But an endpoint might not generate message 180 and send message 183 right away as shown in the following diagram.</span></span>

4.  <span data-ttu-id="e495d-257">Depois que um ponto de extremidade gera uma mensagem de Resposta de Mídia com os endereços IP dos candidatos à mídia do ponto de extremidade, o proxy SIP converte a mensagem recebida em uma mensagem "Progresso da Sessão SIP 183" com o SDP do cliente substituído pelo SDP do Processador de Mídia.</span><span class="sxs-lookup"><span data-stu-id="e495d-257">Once an endpoint generates a Media Answer message with the IP addresses of endpoint’s media candidates, the SIP proxy converts the message received to a "SIP 183 Session Progress" message with the SDP from the client replaced by the SDP from the Media Processor.</span></span> <span data-ttu-id="e495d-258">No diagrama a seguir, o ponto de extremidade do Bifurcação 2 atendeu à chamada.</span><span class="sxs-lookup"><span data-stu-id="e495d-258">In the following diagram, the endpoint from Fork 2 answered the call.</span></span> <span data-ttu-id="e495d-259">Se o tronco não for ignorado, a mensagem SIP 183 será gerada apenas uma vez (Ring Bot ou Client End Point).</span><span class="sxs-lookup"><span data-stu-id="e495d-259">If the trunk is non-bypassed, the 183 SIP message is generated only once (either Ring Bot or Client End Point).</span></span> <span data-ttu-id="e495d-260">O 183 pode vir em uma bifurcação existente ou iniciar um novo.</span><span class="sxs-lookup"><span data-stu-id="e495d-260">The 183 might come on an existing fork or start a new one.</span></span>

5.  <span data-ttu-id="e495d-261">Uma mensagem de Aceitação de Chamada é enviada com os candidatos finais do ponto de extremidade que aceitaram a chamada.</span><span class="sxs-lookup"><span data-stu-id="e495d-261">A Call Acceptance message is sent with the final candidates of the endpoint that accepted the call.</span></span> <span data-ttu-id="e495d-262">A mensagem aceitação de chamada é convertida na mensagem SIP 200.</span><span class="sxs-lookup"><span data-stu-id="e495d-262">The Call Acceptance message is converted to SIP message 200.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="e495d-263">![Diagrama mostrando vários pontos de extremidade tocando com resposta provisória](media/direct-routing-protocols-1.png)</span><span class="sxs-lookup"><span data-stu-id="e495d-263">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-1.png)</span></span>

#### <a name="multiple-endpoints-ringing-without-provisional-answer"></a><span data-ttu-id="e495d-264">Vários pontos de extremidade tocando sem resposta provisória</span><span class="sxs-lookup"><span data-stu-id="e495d-264">Multiple endpoints ringing without provisional answer</span></span>

1.  <span data-ttu-id="e495d-265">Ao receber o primeiro Convite do SBC, o proxy SIP envia a mensagem "SIP SIP/2.0 100 Tentando" e notifica todos os pontos de extremidade do usuário final sobre a chamada de entrada.</span><span class="sxs-lookup"><span data-stu-id="e495d-265">On receiving the first Invite from the SBC, the SIP proxy sends the message "SIP SIP/2.0 100 Trying" and notifies all end user endpoints about the incoming call.</span></span> 

2.  <span data-ttu-id="e495d-266">Após a notificação, cada ponto de extremidade começará a tocar e enviar a mensagem "Progresso da chamada" para o proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="e495d-266">Upon notification, each endpoint will start ringing and sending the message "Call progress” to the SIP proxy.</span></span> <span data-ttu-id="e495d-267">Como um usuário do Teams pode ter vários pontos de extremidade, o proxy SIP pode receber várias mensagens de Progresso de Chamada.</span><span class="sxs-lookup"><span data-stu-id="e495d-267">Because a Teams user can have multiple end points, the SIP proxy might receive multiple Call Progress messages.</span></span>

3.  <span data-ttu-id="e495d-268">Para cada mensagem de Progresso de Chamada recebida dos clientes, o proxy SIP converte a mensagem Progresso da Chamada para a mensagem SIP "SIP SIP/2.0 180 Trying".</span><span class="sxs-lookup"><span data-stu-id="e495d-268">For every Call Progress message received from the clients, the SIP proxy converts the Call Progress message to the SIP message "SIP SIP/2.0 180 Trying".</span></span>  <span data-ttu-id="e495d-269">O intervalo para o envio das mensagens é definido pelo intervalo de recebimento das mensagens do Controlador de Chamada.</span><span class="sxs-lookup"><span data-stu-id="e495d-269">The interval for sending the messages is defined by the interval of receiving the messages from the Call Controller.</span></span> <span data-ttu-id="e495d-270">Na imagem abaixo, há duas 180 mensagens geradas pelo proxy SIP, o que significa que o usuário se registrou em três clientes do Teams e cada cliente envia o andamento da chamada.</span><span class="sxs-lookup"><span data-stu-id="e495d-270">On the picture below there are two 180 messages generated by the SIP proxy, meaning that user logged into three Teams clients and each client send the call progress.</span></span> <span data-ttu-id="e495d-271">Cada mensagem será uma sessão separada (parâmetro "tag" no campo "Para" é diferente)</span><span class="sxs-lookup"><span data-stu-id="e495d-271">Every message will be a separate session (parameter “tag” in “To” field is different)</span></span>

4.  <span data-ttu-id="e495d-272">Uma mensagem de Aceitação de Chamada é enviada com os candidatos finais do ponto de extremidade que aceitaram a chamada.</span><span class="sxs-lookup"><span data-stu-id="e495d-272">A Call Acceptance message is sent with the final candidates of the endpoint that accepted the call.</span></span> <span data-ttu-id="e495d-273">A mensagem aceitação de chamada é convertida na mensagem SIP 200.</span><span class="sxs-lookup"><span data-stu-id="e495d-273">The Call Acceptance message is converted to SIP message 200.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="e495d-274">![Diagrama mostrando vários pontos de extremidade tocando sem resposta provisória](media/direct-routing-protocols-2.png)</span><span class="sxs-lookup"><span data-stu-id="e495d-274">![Diagram showing multiple endpoints ringing without provisional answer](media/direct-routing-protocols-2.png)</span></span>

### <a name="media-bypass-flow"></a><span data-ttu-id="e495d-275">Fluxo de bypass de mídia</span><span class="sxs-lookup"><span data-stu-id="e495d-275">Media bypass flow</span></span>

<span data-ttu-id="e495d-276">As mesmas mensagens (100 Tentando, 180, 183) são usadas no cenário de bypass de mídia.</span><span class="sxs-lookup"><span data-stu-id="e495d-276">The same messages (100 Trying, 180, 183) are used in the media bypass scenario.</span></span> 

<span data-ttu-id="e495d-277">O esquema abaixo mostra um exemplo do fluxo de chamada de bypass.</span><span class="sxs-lookup"><span data-stu-id="e495d-277">The schema below shows an example of the bypass call flow.</span></span> 

> [!NOTE]
> <span data-ttu-id="e495d-278">Os candidatos à mídia podem vir de pontos de extremidade diferentes.</span><span class="sxs-lookup"><span data-stu-id="e495d-278">The media candidates can come from different endpoints.</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="e495d-279">![Diagrama mostrando vários pontos de extremidade tocando com resposta provisória](media/direct-routing-protocols-3.png)</span><span class="sxs-lookup"><span data-stu-id="e495d-279">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-3.png)</span></span>

## <a name="replaces-option"></a><span data-ttu-id="e495d-280">Substitui a opção</span><span class="sxs-lookup"><span data-stu-id="e495d-280">Replaces option</span></span>

<span data-ttu-id="e495d-281">O SBC deve dar suporte a Convidar com Substituições.</span><span class="sxs-lookup"><span data-stu-id="e495d-281">The SBC must support Invite with Replaces.</span></span>

## <a name="size-of-sdp-considerations"></a><span data-ttu-id="e495d-282">Tamanho das considerações de SDP</span><span class="sxs-lookup"><span data-stu-id="e495d-282">Size of SDP considerations</span></span>

<span data-ttu-id="e495d-283">A interface de Roteamento Direto pode enviar uma mensagem SIP superior a 1.500 bytes.</span><span class="sxs-lookup"><span data-stu-id="e495d-283">The Direct Routing interface might send a SIP message exceeding 1,500 bytes.</span></span>  <span data-ttu-id="e495d-284">O tamanho do SDP causa isso principalmente.</span><span class="sxs-lookup"><span data-stu-id="e495d-284">The size of SDP primarily causes this.</span></span> <span data-ttu-id="e495d-285">No entanto, se houver um tronco UDP atrás do SBC, ele poderá rejeitar a mensagem se for encaminhada do proxy SIP da Microsoft para o tronco nãomodificado.</span><span class="sxs-lookup"><span data-stu-id="e495d-285">However, if there is a UDP trunk behind the SBC, it might reject the message if it is forwarded from the Microsoft SIP proxy to the trunk unmodified.</span></span> <span data-ttu-id="e495d-286">A Microsoft recomenda a desmoção de alguns valores no SDP no SBC ao enviar a mensagem para os troncos UDP.</span><span class="sxs-lookup"><span data-stu-id="e495d-286">Microsoft recommends stripping some values in SDP on the SBC when sending the message to the UDP trunks.</span></span> <span data-ttu-id="e495d-287">Por exemplo, os candidatos ICE ou codecs não usadas podem ser removidos.</span><span class="sxs-lookup"><span data-stu-id="e495d-287">For example, the ICE candidates or unused codecs can be removed.</span></span>

## <a name="call-transfer"></a><span data-ttu-id="e495d-288">Transferência de chamada</span><span class="sxs-lookup"><span data-stu-id="e495d-288">Call transfer</span></span>

<span data-ttu-id="e495d-289">O Roteamento Direto dá suporte a dois métodos para transferência de chamada:</span><span class="sxs-lookup"><span data-stu-id="e495d-289">Direct Routing supports two methods for call transfer:</span></span>

- <span data-ttu-id="e495d-290">Opção 1.</span><span class="sxs-lookup"><span data-stu-id="e495d-290">Option 1.</span></span> <span data-ttu-id="e495d-291">Processos de proxy SIP Refer from the client locally and acts as a Referee as described in section 7.1 of RFC 3892.</span><span class="sxs-lookup"><span data-stu-id="e495d-291">SIP proxy processes Refer from the client locally and acts as a Referee as described in section 7.1 of RFC 3892.</span></span>

  <span data-ttu-id="e495d-292">Com essa opção, o proxy SIP encerra a transferência e adiciona um novo Invite.</span><span class="sxs-lookup"><span data-stu-id="e495d-292">With this option, the SIP proxy terminates the transfer and adds a new Invite.</span></span> 


- <span data-ttu-id="e495d-293">Opção 2. </span><span class="sxs-lookup"><span data-stu-id="e495d-293">Option 2.</span></span> <span data-ttu-id="e495d-294">O proxy SIP envia o refer to the SBC e age como um Transferor conforme descrito na Seção 6 da RFC 5589.</span><span class="sxs-lookup"><span data-stu-id="e495d-294">SIP proxy sends the Refer to the SBC and acts as a Transferor as describing in Section 6 of RFC 5589.</span></span>

  <span data-ttu-id="e495d-295">Com essa opção, o proxy SIP envia um Refer para o SBC e espera que o SBC manipulará totalmente a Transferência.</span><span class="sxs-lookup"><span data-stu-id="e495d-295">With this option, the SIP proxy sends a Refer to the SBC and expects the SBC to handle the Transfer fully.</span></span>

<span data-ttu-id="e495d-296">O proxy SIP seleciona o método com base nos recursos relatados pelo SBC.</span><span class="sxs-lookup"><span data-stu-id="e495d-296">The SIP proxy selects the method based on the capabilities reported by the SBC.</span></span> <span data-ttu-id="e495d-297">Se o SBC indicar que ele dá suporte ao método "Refer", o proxy SIP usará a Opção 2 para transferências de chamada.</span><span class="sxs-lookup"><span data-stu-id="e495d-297">If the SBC indicates that it supports the method “Refer”, the SIP proxy will use Option 2 for call transfers.</span></span>

<span data-ttu-id="e495d-298">Veja a seguir um exemplo de um SBC enviando a mensagem de suporte para o método Refer:</span><span class="sxs-lookup"><span data-stu-id="e495d-298">The following is an example of an SBC sending the message that the Refer method is supported:</span></span>

```console
ALLOW: INVITE, OPTIONS, INFO, BYE, CANCEL, ACK, PRACK, UPDATE, REFER, SUBSCRIBE, NOTIFY
```

<span data-ttu-id="e495d-299">Se o SBC não indicar que Refer como um método com suporte, o Roteamento Direto usará a Opção 1 (proxy SIP age como um Referee) .</span><span class="sxs-lookup"><span data-stu-id="e495d-299">If the SBC doesn’t indicate that Refer as a supported method, Direct Routing will use Option 1 (SIP proxy acts as a Referee) .</span></span> <span data-ttu-id="e495d-300">O SBC também deve sinalizar que ele dá suporte ao método Notify:</span><span class="sxs-lookup"><span data-stu-id="e495d-300">The SBC  must also signal that it supports the Notify method:</span></span>

<span data-ttu-id="e495d-301">Exemplo de SBC indicando que o método Refer não tem suporte:</span><span class="sxs-lookup"><span data-stu-id="e495d-301">Example of SBC indicating that Refer method is not supported:</span></span>

```console
ALLOW: INVITE, ACK, CANCEL, BYE, INFO, NOTIFY, PRACK, UPDATE, OPTIONS
```

### <a name="sip-proxy-processes-refer-from-the-client-locally-and-acts-as-a-referee"></a><span data-ttu-id="e495d-302">Processos de proxy SIP Referem-se ao cliente localmente e age como um Referee</span><span class="sxs-lookup"><span data-stu-id="e495d-302">SIP proxy processes Refer from the client locally and acts as a Referee</span></span>

<span data-ttu-id="e495d-303">Se o SBC indicar que o método Refer não tem suporte, o proxy SIP atuará como um Referee.</span><span class="sxs-lookup"><span data-stu-id="e495d-303">If the SBC indicated that the Refer method is not supported, the SIP proxy acts as a Referee.</span></span> 

<span data-ttu-id="e495d-304">A solicitação Refer que vem do cliente será encerrada no proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="e495d-304">The Refer request that comes from the client will be terminated on the SIP proxy.</span></span> <span data-ttu-id="e495d-305">(A solicitação Refer do cliente é mostrada como "Transferência de chamada para Dave" no diagrama a seguir.</span><span class="sxs-lookup"><span data-stu-id="e495d-305">(The Refer request from the client is shown as “Call transfer to Dave” in the following diagram.</span></span>  <span data-ttu-id="e495d-306">Para obter mais informações, consulte a seção 7.1 de [RFC 3892](https://www.ietf.org/rfc/rfc3892.txt).</span><span class="sxs-lookup"><span data-stu-id="e495d-306">For more information, see section 7.1 of [RFC 3892](https://www.ietf.org/rfc/rfc3892.txt).</span></span> 

> [!div class="mx-imgBorder"]
> <span data-ttu-id="e495d-307">![Diagrama mostrando vários pontos de extremidade tocando com resposta provisória](media/direct-routing-protocols-4.png)</span><span class="sxs-lookup"><span data-stu-id="e495d-307">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-4.png)</span></span>

### <a name="sip-proxy-send-the-refer-to-the-sbc-and-acts-as-a-transferor"></a><span data-ttu-id="e495d-308">Proxy SIP envia o refer to the SBC e age como um Transferor</span><span class="sxs-lookup"><span data-stu-id="e495d-308">SIP proxy send the Refer to the SBC and acts as a Transferor</span></span>

<span data-ttu-id="e495d-309">Esse é o método preferencial para transferências de chamada e é obrigatório para dispositivos que procuram a certificação de bypass de mídia.</span><span class="sxs-lookup"><span data-stu-id="e495d-309">This is the preferred method for call transfers, and it is mandatory for devices seeking media bypass certification.</span></span> <span data-ttu-id="e495d-310">A transferência de chamada sem que o SBC possa manipular Refer não é suportada no modo de bypass de mídia.</span><span class="sxs-lookup"><span data-stu-id="e495d-310">Call Transfer without the SBC being able to handle Refer is not supported in media bypass mode.</span></span> 

<span data-ttu-id="e495d-311">O padrão é explicado na Seção 6 da RFC 5589.</span><span class="sxs-lookup"><span data-stu-id="e495d-311">The standard is explained in Section 6 of RFC 5589.</span></span> <span data-ttu-id="e495d-312">Os RFCs relacionados são:</span><span class="sxs-lookup"><span data-stu-id="e495d-312">The related RFCs are:</span></span>

- [<span data-ttu-id="e495d-313">Controle de chamada sip (protocolo de iniciação de sessão) - Transferência</span><span class="sxs-lookup"><span data-stu-id="e495d-313">Session Initiation Protocol (SIP) Call Control - Transfer</span></span>](https://tools.ietf.org/html/rfc5589)

- [<span data-ttu-id="e495d-314">Header "Substitui" do Protocolo de Iniciação de Sessão (SIP)</span><span class="sxs-lookup"><span data-stu-id="e495d-314">Session Initiation Protocol (SIP) "Replaces" Header</span></span>](https://tools.ietf.org/html/rfc3891)

- [<span data-ttu-id="e495d-315">Mecanismo SIP (Session Initiation Protocol) "Referred-By"</span><span class="sxs-lookup"><span data-stu-id="e495d-315">Session Initiation Protocol (SIP) "Referred-By" mechanism</span></span>](https://tools.ietf.org/html/rfc3892)

<span data-ttu-id="e495d-316">Essa opção assume que o proxy SIP age como um Transferor e envia uma mensagem Refer para o SBC.</span><span class="sxs-lookup"><span data-stu-id="e495d-316">This option assumes that the SIP proxy acts as a Transferor and sends a Refer message to the SBC.</span></span> <span data-ttu-id="e495d-317">O SBC age como um Transferee e lida com Refer para gerar uma nova oferta de transferência.</span><span class="sxs-lookup"><span data-stu-id="e495d-317">The SBC acts as a Transferee and handles the Refer to generate a new offer for transfer.</span></span> <span data-ttu-id="e495d-318">Há dois casos possíveis:</span><span class="sxs-lookup"><span data-stu-id="e495d-318">There are two possible cases:</span></span>

- <span data-ttu-id="e495d-319">A chamada é transferida para um participante PSTN externo.</span><span class="sxs-lookup"><span data-stu-id="e495d-319">The call is transferred to an external PSTN participant.</span></span> 
- <span data-ttu-id="e495d-320">A chamada é transferida de um usuário do Teams para outro usuário do Teams no mesmo locatário por meio do SBC.</span><span class="sxs-lookup"><span data-stu-id="e495d-320">The call is transferred from one Teams user to another Teams user in the same tenant via the SBC.</span></span> 

<span data-ttu-id="e495d-321">Se a chamada for transferida de um usuário do Teams para outro por meio do SBC, o SBC deverá emitir um novo convite (iniciar uma nova caixa de diálogo) para o destino de transferência (o usuário do Teams) usando as informações recebidas na mensagem Referir.</span><span class="sxs-lookup"><span data-stu-id="e495d-321">If the call is transferred from one Teams user to another via the SBC, the SBC is expected to issue a new invite (start a new dialog) for the transfer target (the Teams user) using the information received in the Refer message.</span></span> 

<span data-ttu-id="e495d-322">Para preencher os campos To/Transferor para a transação da solicitação internamente, o proxy SIP precisa transmitir essas informações dentro dos headers REFER-TO/REFERRED-BY.</span><span class="sxs-lookup"><span data-stu-id="e495d-322">To populate the To/Transferor fields for the transaction of the request internally, the SIP proxy needs to convey this information  inside the REFER-TO/REFERRED-BY headers.</span></span> 

<span data-ttu-id="e495d-323">O proxy SIP formará o REFER-TO como um URI SIP composto por um FQDN de proxy SIP no nome do host e um dos seguintes:</span><span class="sxs-lookup"><span data-stu-id="e495d-323">The SIP proxy will form the REFER-TO as a SIP URI comprised of a SIP proxy FQDN in the hostname and either one of the following:</span></span>

- <span data-ttu-id="e495d-324">Um número de telefone E.164 na parte de nome de usuário do URI caso o destino da transferência seja um número de telefone ou</span><span class="sxs-lookup"><span data-stu-id="e495d-324">An E.164 phone number in the username part of the URI in case the transfer target is a phone number, or</span></span>

- <span data-ttu-id="e495d-325">Parâmetros x-m e x-t codificando a MRI de destino de transferência completa e a ID do locatário, respectivamente</span><span class="sxs-lookup"><span data-stu-id="e495d-325">x-m and x-t parameters encoding the full transfer target MRI and tenant ID respectively</span></span> 

<span data-ttu-id="e495d-326">O header REFERRED-BY é um URI SIP com MRI transferor codificado nele, bem como a ID de locatário do transferidor e outros parâmetros de contexto de transferência, conforme mostrado na tabela a seguir:</span><span class="sxs-lookup"><span data-stu-id="e495d-326">The REFERRED-BY header is a SIP URI with transferor MRI encoded in it as well as transferor tenant ID and other transfer context parameters as shown in the following table:</span></span>

| <span data-ttu-id="e495d-327">Parâmetro</span><span class="sxs-lookup"><span data-stu-id="e495d-327">Parameter</span></span> | <span data-ttu-id="e495d-328">Valor</span><span class="sxs-lookup"><span data-stu-id="e495d-328">Value</span></span> | <span data-ttu-id="e495d-329">Descrição</span><span class="sxs-lookup"><span data-stu-id="e495d-329">Description</span></span> |  
|:---------------------  |:---------------------- |:---------------------- |
| <span data-ttu-id="e495d-330">x-m</span><span class="sxs-lookup"><span data-stu-id="e495d-330">x-m</span></span> | <span data-ttu-id="e495d-331">MRI</span><span class="sxs-lookup"><span data-stu-id="e495d-331">MRI</span></span> | <span data-ttu-id="e495d-332">MRI completa do destino de transferência/transferência, conforme preenchido pelo CC</span><span class="sxs-lookup"><span data-stu-id="e495d-332">Full MRI of transferor/transfer target as populated by CC</span></span> |
| <span data-ttu-id="e495d-333">x-t</span><span class="sxs-lookup"><span data-stu-id="e495d-333">x-t</span></span> | <span data-ttu-id="e495d-334">ID do locatário</span><span class="sxs-lookup"><span data-stu-id="e495d-334">Tenant ID</span></span> | <span data-ttu-id="e495d-335">ID opcional do locatário x-t, conforme preenchido pelo CC</span><span class="sxs-lookup"><span data-stu-id="e495d-335">x-t Tenant ID Optional Tenant ID as populated by CC</span></span> |
| <span data-ttu-id="e495d-336">x-ti</span><span class="sxs-lookup"><span data-stu-id="e495d-336">x-ti</span></span> | <span data-ttu-id="e495d-337">ID de Correlação do Transferidor</span><span class="sxs-lookup"><span data-stu-id="e495d-337">Transferor Correlation Id</span></span> | <span data-ttu-id="e495d-338">ID de correlação da chamada para o transferidor</span><span class="sxs-lookup"><span data-stu-id="e495d-338">Correlation ID of the call to the transferor</span></span> |
| <span data-ttu-id="e495d-339">x-tt</span><span class="sxs-lookup"><span data-stu-id="e495d-339">x-tt</span></span> | <span data-ttu-id="e495d-340">Transferir URI de chamada de destino</span><span class="sxs-lookup"><span data-stu-id="e495d-340">Transfer target call URI</span></span> | <span data-ttu-id="e495d-341">URI de substituição de chamada codificada</span><span class="sxs-lookup"><span data-stu-id="e495d-341">Encoded call replacement URI</span></span> |

<span data-ttu-id="e495d-342">O tamanho do Header de Referência pode ter até 400 símbolos nesse caso.</span><span class="sxs-lookup"><span data-stu-id="e495d-342">The size of the Refer Header can be up to 400 symbols in this case.</span></span> <span data-ttu-id="e495d-343">O SBC deve dar suporte ao tratamento de Encaminhar mensagens com tamanho de até 400 símbolos.</span><span class="sxs-lookup"><span data-stu-id="e495d-343">The SBC must support handling Refer messages with size up to 400 symbols.</span></span>

> [!div class="mx-imgBorder"]
> <span data-ttu-id="e495d-344">![Diagrama mostrando vários pontos de extremidade tocando com resposta provisória](media/direct-routing-protocols-5.png)</span><span class="sxs-lookup"><span data-stu-id="e495d-344">![Diagram showing multiple endpoints ringing with provisional answer](media/direct-routing-protocols-5.png)</span></span>

## <a name="session-timer"></a><span data-ttu-id="e495d-345">Timer de sessão</span><span class="sxs-lookup"><span data-stu-id="e495d-345">Session timer</span></span>

<span data-ttu-id="e495d-346">O proxy SIP dá suporte (sempre oferece) o Timer de Sessão em chamadas que não ignoram, mas não o oferece em chamadas de bypass.</span><span class="sxs-lookup"><span data-stu-id="e495d-346">The SIP proxy supports (always offers) the Session Timer on non-bypass calls but does not offer it on bypass calls.</span></span> <span data-ttu-id="e495d-347">O uso do Temporizador de Sessão pelo SBC não é obrigatório.</span><span class="sxs-lookup"><span data-stu-id="e495d-347">Use of the Session Timer by the SBC is not mandatory.</span></span>

##  <a name="use-of-request-uri-parameter-userphone"></a><span data-ttu-id="e495d-348">Uso do parâmetro Request-URI user=phone</span><span class="sxs-lookup"><span data-stu-id="e495d-348">Use of Request-URI parameter user=phone</span></span>

<span data-ttu-id="e495d-349">O proxy SIP analisa o Request-URI e, se o parâmetro user=phone estiver presente, o serviço tratará o Request-URI como um número de telefone, correspondendo o número a um usuário.</span><span class="sxs-lookup"><span data-stu-id="e495d-349">The SIP proxy analyses the Request-URI and if the parameter user=phone is present, the service will handle the Request-URI as a phone number, matching the number to a user.</span></span> <span data-ttu-id="e495d-350">Se o parâmetro não estiver presente, o proxy SIP aplicará heurística para determinar o tipo de usuário Request-URI (número de telefone ou um endereço SIP).</span><span class="sxs-lookup"><span data-stu-id="e495d-350">If parameter is not present the SIP proxy applies heuristics to determine  the Request-URI user type (phone number or a SIP address).</span></span>

<span data-ttu-id="e495d-351">A Microsoft recomenda sempre aplicar o parâmetro user=phone para simplificar o processo de configuração de chamada.</span><span class="sxs-lookup"><span data-stu-id="e495d-351">Microsoft recommends always applying the user=phone parameter to simplify the call setup process.</span></span>

## <a name="history-info-header"></a><span data-ttu-id="e495d-352">History-Info header</span><span class="sxs-lookup"><span data-stu-id="e495d-352">History-Info header</span></span>

<span data-ttu-id="e495d-353">O History-Info é usado para retargeting de solicitações SIP e "fornecer(s) um mecanismo padrão para capturar as informações do histórico de solicitações para habilitar uma ampla variedade de serviços para redes e usuários finais".</span><span class="sxs-lookup"><span data-stu-id="e495d-353">The History-Info header is used for retargeting SIP requests and “provide(s) a standard mechanism for capturing the request history information to enable a wide variety of services for networks and end-users.”</span></span> <span data-ttu-id="e495d-354">Para obter mais informações, [consulte RFC 4244 – Seção 1.1](http://www.ietf.org/rfc/rfc4244.txt).</span><span class="sxs-lookup"><span data-stu-id="e495d-354">For more information, see [RFC 4244 – Section 1.1](http://www.ietf.org/rfc/rfc4244.txt).</span></span> <span data-ttu-id="e495d-355">Para o Microsoft Phone System, esse header é usado em cenários de Simulring e Encaminhamento de Chamadas.</span><span class="sxs-lookup"><span data-stu-id="e495d-355">For Microsoft Phone System, this header is used in Simulring and Call Forwarding scenarios.</span></span>  

<span data-ttu-id="e495d-356">Se o envio, a History-Info está habilitada da seguinte forma:</span><span class="sxs-lookup"><span data-stu-id="e495d-356">If sending, the History-Info is enabled as follows:</span></span>

- <span data-ttu-id="e495d-357">O proxy SIP inserirá um parâmetro que contém o número de telefone associado em entradas History-Info individuais que compõem o History-Info de History-Info enviado ao Controlador PSTN.</span><span class="sxs-lookup"><span data-stu-id="e495d-357">The SIP proxy will insert a parameter containing the associated phone number in individual History-Info entries that comprise the History-Info header sent to the PSTN Controller.</span></span>  <span data-ttu-id="e495d-358">Usando apenas entradas que tenham o parâmetro de número de telefone, o Controlador PSTN recriará um novo History-Info de History-Info e o transmitirá ao provedor de tronco SIP por meio de proxy SIP.</span><span class="sxs-lookup"><span data-stu-id="e495d-358">Using only entries that have the phone number parameter, the PSTN Controller will rebuild a new History-Info header, and pass it on to the SIP trunk provider via SIP proxy.</span></span>

- <span data-ttu-id="e495d-359">History-Info header será adicionado para casos simultâneos de encaminhamento de chamada e anel.</span><span class="sxs-lookup"><span data-stu-id="e495d-359">History-Info header will be added for simultaneous ring and call forwarding cases.</span></span>

- <span data-ttu-id="e495d-360">History-Info header não será adicionado para casos de transferência de chamada.</span><span class="sxs-lookup"><span data-stu-id="e495d-360">History-Info header will not be added for call transfer cases.</span></span>

- <span data-ttu-id="e495d-361">Uma entrada de histórico individual no header History-Info reconstruído terá o parâmetro número de telefone fornecido combinado com o FQDN de Roteamento Direto (sip.pstnhub.microsoft.com) definido como a parte host do URI; um parâmetro de 'user=phone' será adicionado como parte do URI SIP.</span><span class="sxs-lookup"><span data-stu-id="e495d-361">An individual history entry in the reconstructed History-Info header will have the phone number parameter provided combined with the Direct Routing FQDN (sip.pstnhub.microsoft.com) set as the host part of the URI; a parameter of ‘user=phone’ will be added as part of the SIP URI.</span></span>  <span data-ttu-id="e495d-362">Quaisquer outros parâmetros associados ao History-Info original, exceto os parâmetros de contexto do telefone, serão passados no header de History-Info.</span><span class="sxs-lookup"><span data-stu-id="e495d-362">Any other parameters associated with the original History-Info header, except for phone context parameters, will be passed through in the re-constructed History-Info header.</span></span>  

  > [!NOTE]
  > <span data-ttu-id="e495d-363">Entradas privadas (conforme determinado pelos mecanismos definidos na Seção 3.3 do RFC 4244) serão encaminhadas como é porque o provedor de tronco SIP é um par confiável.</span><span class="sxs-lookup"><span data-stu-id="e495d-363">Entries that are private (as determined by the mechanisms defined in Section 3.3 of RFC 4244) will be forwarded as is because  the SIP trunk provider is a trusted peer.</span></span>

- <span data-ttu-id="e495d-364">O History-Info de entrada é ignorado.</span><span class="sxs-lookup"><span data-stu-id="e495d-364">Inbound History-Info is ignored.</span></span>

<span data-ttu-id="e495d-365">A seguir está o formato do header History-info enviado pelo proxy SIP:</span><span class="sxs-lookup"><span data-stu-id="e495d-365">Following is the format of the History-info header sent by the SIP proxy:</span></span>

```console
<sip:UserB@sip.pstnhub.microsoft.com?Privacy=history&Reason=SIP%3B\cause%3D486>;index=1.2,
```

<span data-ttu-id="e495d-366">Se a chamada foi redirecionada várias vezes, as informações sobre cada redirecionamento serão incluídas com o motivo apropriado em ordem cronológica.</span><span class="sxs-lookup"><span data-stu-id="e495d-366">If the call was redirected several times, information about every redirect is included with the appropriate reason in chronological order.</span></span>


<span data-ttu-id="e495d-367">Exemplo de header:</span><span class="sxs-lookup"><span data-stu-id="e495d-367">Header Example:</span></span>

```console
History-info: 
<sip:+14257123456@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=302;text=”Move Temporarily”>;index=1
<sip:+14257123457@sip.pstnhub.microsoft.com;user=phone?Reason=SIP;cause=496;text=”User Busy”>;index=1.1
```

<span data-ttu-id="e495d-368">O History-Info é protegido por um mecanismo TLS obrigatório.</span><span class="sxs-lookup"><span data-stu-id="e495d-368">The History-Info is protected by a mandatory TLS mechanism.</span></span> 

## <a name="sbc-connection-to-direct-routing-and-failover-mechanism"></a><span data-ttu-id="e495d-369">Conexão SBC com o mecanismo de roteamento direto e failover</span><span class="sxs-lookup"><span data-stu-id="e495d-369">SBC connection to Direct Routing and failover mechanism</span></span>

<span data-ttu-id="e495d-370">Consulte a seção Mecanismo de Failover para sinalização SIP em [Plan for Direct Routing](direct-routing-plan.md#failover-mechanism-for-sip-signaling).</span><span class="sxs-lookup"><span data-stu-id="e495d-370">See the section Failover mechanism for SIP signaling in [Plan for Direct Routing](direct-routing-plan.md#failover-mechanism-for-sip-signaling).</span></span>

## <a name="retry-after"></a><span data-ttu-id="e495d-371">Retry-After</span><span class="sxs-lookup"><span data-stu-id="e495d-371">Retry-After</span></span>

<span data-ttu-id="e495d-372">Se um datacenter de Roteamento Direto estiver ocupado, o serviço poderá enviar uma mensagem Retry-After com um intervalo de um segundo para o SBC.</span><span class="sxs-lookup"><span data-stu-id="e495d-372">If a Direct Routing datacenter is busy, the service can send a Retry-After message with a one-second interval to the SBC.</span></span> <span data-ttu-id="e495d-373">Quando o SBC recebe uma mensagem 503 com um Retry-After em resposta a um INVITE, o SBC deve encerrar essa conexão e tentar o próximo datacenter da Microsoft disponível.</span><span class="sxs-lookup"><span data-stu-id="e495d-373">When the SBC receives a 503 message with a Retry-After header in response to an INVITE, the SBC must terminate that connection and try the next available Microsoft datacenter.</span></span>

## <a name="handling-retries-603-response"></a><span data-ttu-id="e495d-374">Tratamento de recuperações (resposta 603)</span><span class="sxs-lookup"><span data-stu-id="e495d-374">Handling retries (603 response)</span></span>
<span data-ttu-id="e495d-375">Se um usuário final observar várias chamadas perdidas para uma chamada após o declínio da chamada de entrada, isso significa que o mecanismo de nova tentativa do provedor de tronco SBC ou PSTN está mal configurado.</span><span class="sxs-lookup"><span data-stu-id="e495d-375">If an end user observes several missed calls for one call after declining the incoming call, it means that the SBC or PSTN trunk provider's retry mechanism is misconfigured.</span></span> <span data-ttu-id="e495d-376">O SBC deve ser reconfigurado para interromper os esforços de nova tentativa na resposta 603.</span><span class="sxs-lookup"><span data-stu-id="e495d-376">The SBC must be reconfigured to stop the retry efforts on the 603 response.</span></span>

## <a name="ice-restart-media-bypass-call-transferred-to-an-endpoint-that-does-not-support-media-bypass"></a><span data-ttu-id="e495d-377">Reinicialização de ICE: Chamada de bypass de mídia transferida para um ponto de extremidade que não dá suporte a bypass de mídia</span><span class="sxs-lookup"><span data-stu-id="e495d-377">ICE Restart: Media bypass call transferred to an endpoint that does not support media bypass</span></span>

<span data-ttu-id="e495d-378">O SBC deve dar suporte a reinicializações de ICE conforme descrito na [RFC 5245, seção 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1).</span><span class="sxs-lookup"><span data-stu-id="e495d-378">The SBC must support ICE restarts as described in [RFC 5245, section 9.1.1.1](https://tools.ietf.org/html/rfc5245#section-9.1.1.1).</span></span>

<span data-ttu-id="e495d-379">A reinicialização no Roteamento Direto é implementada de acordo com os seguintes parágrafos da RFC:</span><span class="sxs-lookup"><span data-stu-id="e495d-379">The restart in Direct Routing is implemented according to the following paragraphs of the RFC:</span></span>

<span data-ttu-id="e495d-380">*Para reiniciar o ICE, um agente DEVE alterar o ice-pwd e o ice-ufrag para o fluxo de mídia em uma oferta.  Observe que é permitido usar um atributo de nível de sessão em uma oferta, mas para fornecer o mesmo ice-pwd ou ice-ufrag como um atributo de nível de mídia em uma oferta subsequente.  Isso não é uma alteração na senha, apenas uma alteração em sua representação e não causa uma reinicialização de ICE.*</span><span class="sxs-lookup"><span data-stu-id="e495d-380">*To restart ICE, an agent MUST change both the ice-pwd and the ice-ufrag for the media stream in an offer.  Note that it is permissible to use a session-level attribute in one offer, but to provide the same ice-pwd or ice-ufrag as a media-level attribute in a subsequent offer.  This is not a change in password, just a change in its representation, and does not cause an ICE restart.*</span></span>

<span data-ttu-id="e495d-381">*Um agente define o restante dos campos no SDP para esse fluxo de mídia como faria em uma oferta inicial desse fluxo de mídia (consulte a Seção 4.3).  Consequentemente, o conjunto de candidatos PODE incluir alguns, nenhum ou todos os candidatos anteriores para esse fluxo e MAY incluem um conjunto totalmente novo de candidatos coletados, conforme descrito na Seção 4.1.1.*</span><span class="sxs-lookup"><span data-stu-id="e495d-381">*An agent sets the rest of the fields in the SDP for this media stream as it would in an initial offer of this media stream (see Section 4.3).  Consequently, the set of candidates MAY include some, none, or all of the previous candidates for that stream and MAY include a totally new set of candidates gathered as described in Section 4.1.1.*</span></span>

<span data-ttu-id="e495d-382">Se a chamada foi estabelecida inicialmente com bypass de mídia e a chamada é transferida para um cliente do Skype for Business, o Roteamento Direto precisa inserir um Processador de Mídia, isso porque o Roteamento Direto não pode ser usado com um cliente skype for Business com bypass de mídia.</span><span class="sxs-lookup"><span data-stu-id="e495d-382">If the call was initially established with media bypass, and the call is transferred to a Skype for Business client, Direct Routing needs to insert a Media Processor--this is because Direct Routing cannot be used with a Skype for Business client with media bypass.</span></span> <span data-ttu-id="e495d-383">O Roteamento Direto inicia o processo de reinicialização do ICE alterando o ice-pwd e o ice-ufrag e oferecendo novos candidatos à mídia em uma reinvite.</span><span class="sxs-lookup"><span data-stu-id="e495d-383">Direct Routing starts the ICE restart process by  changing the ice-pwd and ice-ufrag and offering new media candidates in a reinvite.</span></span>
